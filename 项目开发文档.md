# My-BFF 项目开发文档

## 项目概述

这是一个基于 **Koa.js + TypeScript** 的 BFF（Backend For Frontend）服务项目。项目采用现代化的 Node.js 开发模式，集成了依赖注入、模板引擎、静态文件服务等功能。

## 技术栈

### 核心框架
- **Koa.js 3.0.1** - 轻量级 Node.js Web 框架
- **TypeScript 5.9.2** - 提供类型安全的 JavaScript 超集
- **Node.js** - 运行时环境

### 主要依赖库
- **@koa/router 14.0.0** - Koa 路由中间件
- **awilix 12.0.5** - 依赖注入容器
- **awilix-koa 11.1.0** - Koa 集成的依赖注入
- **nunjucks 3.2.4** - 模板引擎
- **koa-nunjucks-2 3.0.2** - Koa 的 Nunjucks 中间件
- **koa-static 5.0.0** - 静态文件服务中间件
- **koa2-connect-history-api-fallback 0.1.3** - SPA 路由回退支持

### 开发工具
- **ts-node-dev 2.0.0** - 开发服务器，支持装饰器和热重载
- **nodemon 3.1.10** - 自动重启开发服务器
- **ts-node 10.9.2** - 直接运行 TypeScript 文件
- **@types/*** - TypeScript 类型定义文件

## 项目结构

```
my-bff/
├── src/                          # 源代码目录
│   ├── @types/                   # 类型定义文件
│   │   ├── IApi.ts              # API 接口定义
│   │   └── koa-nunjucks-2.d.ts  # 第三方库类型声明
│   ├── controllers/              # 控制器层
│   │   ├── homeController.ts     # 首页控制器
│   │   ├── userController.ts     # 用户控制器
│   │   ├── apiController.ts      # API控制器
│   │   └── decoratorController.ts # 装饰器风格控制器
│   ├── services/                # 服务层
│   │   ├── IUserService.ts      # 用户服务接口
│   │   └── userService.ts       # 用户服务实现
│   ├── views/                   # 模板文件
│   │   ├── index.html           # 首页模板
│   │   └── user.html            # 用户页面模板
│   ├── public/                  # 静态文件目录
│   │   └── index.html           # 静态首页
│   └── app.ts                   # 应用入口文件
├── dist/                        # 编译输出目录
├── node_modules/                # 依赖包目录
├── package.json                 # 项目配置文件
├── tsconfig.json               # TypeScript 配置
├── nodemon.json                # nodemon 配置
├── pnpm-lock.yaml              # pnpm 锁文件
├── pnpm-workspace.yaml         # pnpm 工作区配置
└── killport.sh                 # 端口清理脚本
```

## 核心架构设计

### 1. 分层架构
项目采用经典的三层架构模式：
- **Controller 层**: 处理 HTTP 请求，调用服务层，返回响应
- **Service 层**: 业务逻辑处理，数据操作
- **View 层**: 模板渲染，用户界面展示

### 2. 依赖注入
使用 `awilix` 实现依赖注入：
```typescript
// 容器配置 (app.ts:39-48)
const container = createContainer();
container.register({
  userService: {
    resolve: () => new UserService(),
    lifetime: Lifetime.SINGLETON
  }
});
```

### 3. 接口驱动开发
通过 TypeScript 接口确保类型安全：
```typescript
// 服务接口定义 (IUserService.ts)
export interface IUserService {
  getUser(id: string): User;
}
```

## 详细开发指南

### 第一步：环境准备

1. **确保已安装 Node.js** (建议 16.0+)
2. **安装 pnpm 包管理器**：
   ```bash
   npm install -g pnpm
   ```

### 第二步：项目初始化

1. **克隆/下载项目**
2. **安装依赖**：
   ```bash
   pnpm install
   ```

### 第三步：项目配置文件详解

#### package.json 配置解析
```json
{
  "scripts": {
    "start": "node dist/app.js",      // 生产环境启动
    "build": "tsc",                   // 编译 TypeScript
    "dev": "ts-node-dev --respawn --transpile-only src/app.ts"  // 开发环境启动(支持装饰器)
  }
}
```

#### tsconfig.json 配置解析
```json
{
  "compilerOptions": {
    "target": "es2020",               // 编译目标版本
    "module": "commonjs",             // 模块系统
    "outDir": "./dist",               // 输出目录
    "rootDir": "./src",               // 源码目录
    "strict": true                    // 严格类型检查
  }
}
```

#### nodemon.json 配置解析
```json
{
  "watch": ["src"],                   // 监听目录
  "ext": "ts",                        // 监听文件扩展名
  "exec": "ts-node ./src/app.ts"      // 执行命令
}
```

### 第四步：核心文件开发详解

#### 1. 应用入口文件 (src/app.ts)

**关键步骤**：
1. **创建 Koa 应用实例** (app.ts:18)
2. **配置模板引擎** (app.ts:21-27)
3. **配置静态文件服务** (app.ts:30)
4. **配置 SPA 路由回退** (app.ts:33-36)
5. **设置依赖注入容器** (app.ts:39-48)
6. **配置路由** (app.ts:51-72)
7. **启动服务** (app.ts:75-79)

**模板引擎配置**：
```typescript
app.use(nunjucks({
  ext: 'html',                        // 模板文件扩展名
  path: path.join(__dirname, 'views'), // 模板文件路径
  nunjucksConfig: {
    trimBlocks: true,                 // 去除块周围的空白
  },
}));
```

**SPA 路由回退配置**：
```typescript
app.use(historyApiFallback({
  index: '/',                         // 默认页面
  whiteList: ['/api']                 // API 路由不回退
}));
```

#### 2. 控制器开发 (controllers/)

**HomeController 示例**：
```typescript
export default class HomeController {
  async index(ctx: Context) {
    await ctx.render('index', {       // 渲染模板
      title: '欢迎来到我的 BFF 项目!',
    });
  }
}
```

**UserController 示例**：
```typescript
export default class UserController {
  private readonly userService: IUserService;

  constructor({ userService }: IUserControllerDeps) {
    this.userService = userService;   // 依赖注入
  }

  async get(ctx: Context) {
    const userId = ctx.params.id;     // 获取路由参数
    const user = this.userService.getUser(userId);

    await ctx.render('user', {        // 渲染用户页面
      title: '用户详情页',
      user: user,
    });
  }
}
```

#### 3. 服务层开发 (services/)

**接口定义** (IUserService.ts):
```typescript
export interface User {
  id: string;
  name: string;
  email: string;
}

export interface IUserService {
  getUser(id: string): User;
}
```

**服务实现** (userService.ts):
```typescript
export class UserService implements IUserService {
  getUser(id: string): User {
    // 模拟数据返回，实际项目中会连接数据库
    return {
      id: id,
      name: `User-${id}`,
      email: `user${id}@example.com`,
    };
  }
}
```

#### 4. 视图模板开发 (views/)

**Nunjucks 模板语法示例**：
```html
<!-- 变量渲染 -->
<h1>{{ title }}</h1>

<!-- 对象属性访问 -->
<p>用户名: {{ user.name }}</p>
<p>邮箱: {{ user.email }}</p>
```

### 第五步：运行和测试

#### 开发环境运行
```bash
pnpm run dev
```
服务启动后访问：http://localhost:3000

#### 生产环境部署
```bash
# 编译 TypeScript
pnpm run build

# 启动生产服务
pnpm start
```

#### 测试路由
- 首页：`http://localhost:3000/`
- 用户页面：`http://localhost:3000/user/123`

### 第六步：扩展开发

#### 添加新的控制器
1. **创建控制器文件** `src/controllers/newController.ts`
2. **实现控制器类**
3. **在 app.ts 中注册路由**

#### 添加新的服务
1. **定义服务接口** `src/services/INewService.ts`
2. **实现服务类** `src/services/newService.ts`
3. **在容器中注册服务**
4. **在控制器中使用依赖注入**

#### 添加新的模板页面
1. **创建模板文件** `src/views/newPage.html`
2. **在控制器中调用** `ctx.render('newPage', data)`

## 开发最佳实践

### 1. 类型安全
- 始终定义接口和类型
- 使用 TypeScript 的严格模式
- 为第三方库提供类型声明文件

### 2. 依赖注入
- 通过接口定义依赖关系
- 使用容器管理对象生命周期
- 保持单一职责原则

### 3. 错误处理
- 添加适当的错误处理中间件
- 记录详细的错误日志
- 为用户提供友好的错误页面

### 4. 安全考虑
- 输入验证和清理
- CORS 配置
- 安全头设置

## 常见问题排查

### 1. 端口占用问题
```bash
# 使用项目提供的脚本清理端口
./killport.sh 3000
```

### 2. 依赖安装问题
```bash
# 清理缓存重新安装
pnpm cache clean
rm -rf node_modules
pnpm install
```

### 3. 类型错误
- 检查 TypeScript 配置
- 确保类型定义文件正确
- 使用 `pnpm run build` 检查编译错误

## 项目优势

1. **类型安全**: TypeScript 提供编译时类型检查
2. **架构清晰**: 分层设计，职责分离
3. **可维护性**: 依赖注入，接口驱动
4. **开发效率**: 热重载，自动编译
5. **现代化**: 使用最新的 Node.js 生态工具

## 下一步发展方向

1. **添加数据库支持** (MongoDB/MySQL)
2. **集成认证授权** (JWT/OAuth)
3. **添加 API 文档** (Swagger)
4. **引入测试框架** (Jest)
5. **容器化部署** (Docker)
6. **添加日志系统** (Winston)
7. **性能监控** (APM)

这个项目为你提供了一个完整的 BFF 服务开发基础，你可以在此基础上扩展更多功能。
## 🚀 完整路由访问指南

### 启动服务
```bash
# 开发环境启动（支持装饰器和热重载）
pnpm run dev

# 服务启动成功后显示：
# 🚀 服务已启动，正在监听 3000 端口
# 🔗 请访问 http://localhost:3000
```

### 1. 页面路由 (返回HTML页面)

#### 首页
- **URL**: `http://localhost:3000/`
- **方法**: GET
- **说明**: 项目首页，显示欢迎信息
- **返回**: HTML页面

#### 用户页面
- **URL**: `http://localhost:3000/user/1`
- **方法**: GET
- **参数**: 用户ID (可以是任意数字)
- **说明**: 用户详情页面，使用模板渲染
- **返回**: HTML页面

### 2. API路由 (返回JSON数据)

#### 系统健康检查
```bash
curl http://localhost:3000/api/health
```
- **方法**: GET
- **说明**: 检查服务运行状态
- **返回示例**:
```json
{
  "success": true,
  "data": {
    "status": "healthy",
    "timestamp": "2024-09-15T16:00:00.000Z",
    "uptime": 42.096479833,
    "version": "1.0.0"
  },
  "message": "服务运行正常"
}
```

#### 系统信息
```bash
curl http://localhost:3000/api/info
```
- **方法**: GET
- **说明**: 获取系统信息

#### 获取模拟数据
```bash
curl http://localhost:3000/api/mock-data
```
- **方法**: GET
- **说明**: 获取模拟的文章数据

#### 获取单个用户信息
```bash
curl http://localhost:3000/api/user/1
```
- **方法**: GET
- **参数**: 用户ID
- **说明**: 获取指定用户的详细信息

#### 获取所有用户列表
```bash
curl http://localhost:3000/api/users
```
- **方法**: GET
- **说明**: 获取所有用户列表
- **返回示例**:
```json
{
  "success": true,
  "data": [
    {
      "id": "1",
      "name": "Alice",
      "email": "alice@example.com"
    },
    {
      "id": "2", 
      "name": "Bob",
      "email": "bob@example.com"
    },
    {
      "id": "3",
      "name": "Charlie", 
      "email": "charlie@example.com"
    }
  ],
  "message": "获取用户列表成功"
}
```

### 3. 装饰器路由 (AOP风格，完全可用)

**注意**: 装饰器路由已完全配置并测试通过，使用@route和@GET等装饰器实现声明式路由。

#### 装饰器控制器首页
```bash
curl http://localhost:3000/decorator
```
- **方法**: GET
- **说明**: 装饰器风格的控制器首页
- **状态**: ✅ 完全可用
- **返回示例**:
```json
{
  "success": true,
  "data": {
    "controller": "DecoratorController",
    "style": "AOP装饰器风格",
    "routes": [
      "GET /decorator - 控制器首页",
      "GET /decorator/hello - 问候接口",
      "GET /decorator/user/:id - 获取用户信息",
      "POST /decorator/data - 创建数据"
    ]
  },
  "message": "装饰器控制器首页"
}
```

#### 装饰器问候接口
```bash
curl http://localhost:3000/decorator/hello
```
- **方法**: GET
- **说明**: 装饰器风格的问候接口
- **状态**: ✅ 完全可用

#### 装饰器用户信息
```bash
curl http://localhost:3000/decorator/user/123
```
- **方法**: GET
- **参数**: 用户ID
- **说明**: 装饰器风格获取用户信息
- **状态**: ✅ 完全可用
- **返回示例**:
```json
{
  "success": true,
  "data": {
    "id": "123",
    "name": "装饰器用户123",
    "email": "decorator-user123@example.com"
  },
  "message": "装饰器风格获取用户 123 信息成功"
}
```

### 4. 快速测试脚本

创建测试脚本 `test-apis.sh`:
```bash
#!/bin/bash
echo "=== 测试所有API接口 ==="

echo "1. 健康检查:"
curl -s http://localhost:3000/api/health | head -5

echo -e "\n2. 系统信息:"
curl -s http://localhost:3000/api/info | head -5

echo -e "\n3. 用户列表:"
curl -s http://localhost:3000/api/users | head -5

echo -e "\n=== 测试完成 ==="
```

### 5. 路由架构说明

#### 传统路由 (当前使用)
- **配置方式**: 手动配置，明确注册
- **位置**: `src/app.ts` 第65-76行
- **优点**: 简单直观，完全可控
- **状态**: ✅ 完全可用

#### 装饰器路由 (现代化方式)
- **配置方式**: 注解驱动，自动发现
- **位置**: `src/controllers/decoratorController.ts`
- **优点**: 声明式，代码更简洁
- **状态**: 🔧 开发中

### 6. 开发调试技巧

#### 查看服务状态
```bash
# 检查端口占用
lsof -i :3000

# 查看进程
ps aux | grep node
```

#### 重启服务
```bash
# 开发环境会自动重启，也可手动重启
pnpm run dev
```

**当前状态**:
- ✅ **传统路由**: 完全可用，包含页面和API
- ✅ **装饰器支持**: 技术栈配置完成
- ✅ **装饰器路由**: 完全可用，AOP风格声明式路由

这为构建大型 Web 应用奠定了坚实的基础！🚀
